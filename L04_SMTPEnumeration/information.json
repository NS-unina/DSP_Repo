{"description":"Learn how to enumerate host or network users using SMTP verbs","goal":"<p>Use DSP Hack Tools to enumerate SMTP server users.</p>","solution":"<h2>SMTP Enumeration</h2>\n<p>Under certain misconfigurations, SMTP servers can be useful to enumerate network or host users. SMTP protocol provides some interesting commands, such as EXPN and VRFY, that can help obtaining information about users or mailing lists installed on the server.</p>\n<p>Go on and start your lab. In the network drawing section you only see one SMTP server, which is not directly accessible. How are we going to play with it without any tool under our control? Well, we can add containers dynamically thanks to the \"Hack Tools\" feature. Scroll down the page and click on \"Hack Tools\". A new panel opens up and we can create our own service choosing docker images, ports to be forwarded and environment variables to be passed.</p>\n<h3>VRFY command</h3>\n<p>For the first part of this lesson we'll try to connect manually to the SMTP server and try VeRiFYing some users, so we'll need a simple netcat container.</p>\n<p>&nbsp;<img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L04_SMTPEnumeration/.images/netcat_hack_tools.png\" alt=\"\" width=\"1830\" height=\"633\" /></p>\n<p>Click on run and in a few seconds you'll have a Netcat container to use against the SMTP server. However, first we need to attach it to the SMTP server's public network. Click on \"Attach\" in order to obtain a public IP address and then on the radio button next to the name of the network in order to configure the default gateway.</p>\n<p>You should see something like this:</p>\n<p><img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L04_SMTPEnumeration/.images/attach_netcat.png\" alt=\"\" width=\"1827\" height=\"133\" /></p>\n<p>Now let's get access to the freshly created container and connect to the SMTP server using Netcat.</p>\n<p style=\"padding-left: 30px;\">$ ncat -nv 193.21.1.3 25</p>\n<p>&nbsp;<img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L04_SMTPEnumeration/.images/netcat_connect.png\" alt=\"\" width=\"408\" height=\"96\" /></p>\n<p>We already know that Netcat is pretty useful when it comes to grab some banners. In this case we discover that the server is running a Postfix server on Ubuntu.</p>\n<p>Now we can try use the VRFY command to check if some users are installed on the server.</p>\n<p style=\"padding-left: 30px;\">$ VRFY root</p>\n<p>The server sends a 2.0.0 response with status code 252 which confirms that a ROOT user is present.</p>\n<p>&nbsp;<img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L04_SMTPEnumeration/.images/vrfy_root.png\" alt=\"\" width=\"407\" height=\"110\" /></p>\n<p>Let's see what happens when we look for a non-existing user.</p>\n<p style=\"padding-left: 30px;\">$ VRFY ftpd</p>\n<p>&nbsp;<img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L04_SMTPEnumeration/.images/vrfy_ftpd.png\" alt=\"\" width=\"760\" height=\"138\" /></p>\n<p>Now we receive an error code indicating that the user is not installed.</p>\n<h3>PYTHON port</h3>\n<p>Let's try automate a bit this process by writing a simple python script. We can add a new container where python is already installed.</p>\n<p>&nbsp;<img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L04_SMTPEnumeration/.images/python_hack_tool.png\" alt=\"\" width=\"1836\" height=\"688\" /></p>\n<p>Click on \"Run\" and repeat the steps done before to attach containers to the public network.</p>\n<p>&nbsp;<img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L04_SMTPEnumeration/.images/attach_python.png\" alt=\"\" width=\"1832\" height=\"261\" /></p>\n<p>Access the new container's terminal and type</p>\n<p style=\"padding-left: 30px;\">$ ls</p>\n<p>&nbsp;<img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L04_SMTPEnumeration/.images/ls.png\" alt=\"\" width=\"1390\" height=\"62\" /></p>\n<p>You can see there is already a \"vrfy.py\" python script: let's see what's written inside.</p>\n<p style=\"padding-left: 30px;\">$ cat vrfy.py</p>\n<p>&nbsp;<img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L04_SMTPEnumeration/.images/cat_vrfy.png\" alt=\"\" width=\"586\" height=\"381\" /></p>\n<p>Even if you don't have much experience with python, try analyse the script: it's pretty self explanatory. We basically create a socket and use it to connect to the SMTP server on port 25. Next we grab the banner and print it, then we send the VRFY command with the parameter passed from command line and print the response.</p>\n<p>Let's try it out. The usage is \"/vrfy.py &lt;username&gt;</p>\n<p style=\"padding-left: 30px;\">$ /vrfy.py root</p>\n<p><img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L04_SMTPEnumeration/.images/python_vrfy_root.png\" alt=\"\" width=\"437\" height=\"85\" />&nbsp;</p>\n<p>Now we can do the same with the non-installed user</p>\n<p style=\"padding-left: 30px;\">$ /vrfy.py ftpd</p>\n<p>&nbsp;<img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L04_SMTPEnumeration/.images/python_vrfy_ftpd.png\" alt=\"\" width=\"773\" height=\"91\" /></p>\n<h3>Exercise</h3>\n<p>As an exercise, you can try automate the script even more, by passing a list of usernames in a txt file and looping over it with a \"for\" statement. You can modify the script inside the container with the program \"vim\" by tiping</p>\n<p style=\"padding-left: 30px;\">$ vim vrfy.py</p>\n<h3>SMTP-user-enum</h3>\n<p>Fortunately, there is someone who already did that, by writing a Perl script which lets us enumerate SMTP users using the VRFY command and a list of users.</p>\n<p>We have a Docker container which does that for you. Go to Hack Tools and add a new service.</p>\n<p>&nbsp;<img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L04_SMTPEnumeration/.images/enum-hack-tool.png\" alt=\"\" width=\"1826\" height=\"726\" /></p>\n<p>Repeat the already familiar steps to attach the container to the public network.</p>\n<p>&nbsp;<img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L04_SMTPEnumeration/.images/attach_user_enum.png\" alt=\"\" width=\"1821\" height=\"310\" /></p>\n<p>Access the container's terminal and type:</p>\n<p style=\"padding-left: 30px;\">$ smtp-user-enum.pl</p>\n<p>and take a look at the usage examples.</p>\n<p>&nbsp;<img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L04_SMTPEnumeration/.images/smtp-enum-examples.png\" alt=\"\" width=\"983\" height=\"471\" /></p>\n<p>All we need to do is to specify the kind of message, provide a users txt file and tell the IP address of the server.</p>\n<p>In the root directory there is a txt file with a list of the most common linux users. Check it out by typing:</p>\n<p style=\"padding-left: 30px;\">$ cat unix_users.txt</p>\n<p>&nbsp;<img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L04_SMTPEnumeration/.images/unix_users.png\" alt=\"\" width=\"724\" height=\"930\" /></p>\n<p>and so on...</p>\n<p>Let's try the script out:</p>\n<p style=\"padding-left: 30px;\">$ smtp-user-enum.pl -M VRFY -U unix_users.txt -t 193.21.1.3</p>\n<p>&nbsp;<img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L04_SMTPEnumeration/.images/perl_script.png\" alt=\"\" width=\"830\" height=\"843\" /></p>\n<p>We see a bunch of users installed on the server. Now we can go deep into each one of these and look for serious vulnerabilities!</p>","readme":"","difficulty":"Beginner","author":"NS"}
