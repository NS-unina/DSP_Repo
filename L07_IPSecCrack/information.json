{"description":"Sniff IPsec traffic to retrieve the pre-shared key from a bad configured host","goal":"<p>Sniff IPsec traffic to retrieve the pre-shared key then exploit the IKE Aggressive Mode to get the key from the unencrypted hash used in the response packet from the server.</p>","solution":"<h2>Step 1: Find the vulnerable host</h2>\n<p>Before we start to attack, in the lab there is a <em>wireshark</em> container, that can be used to see packets exchanged over the network between the legitimate client and the server.</p>\n<p>Go to <a class=\"url\" href=\"https://localhost:14500/?password=wireshark\" target=\"_blank\" rel=\"noopener noreferrer\">https://localhost:14500/?username=wireshark=password=wireshark</a> and you can see the wireshark interface:<img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L07_IPSecCrack/.images/wiresharkinterface.png\" /></p>\n<p>Select the <strong>bridge interface</strong> (br-xxx). You can see all the traffic on the subnet, but we are interested in <strong>Aggressive Mode</strong> <strong>packets</strong> (a new connection is created every minute to allow wireshark to capture such packets, be patient!).</p>\n<p>To see the IKE messages it's necessary to filter by <strong>ISAKMP protocol</strong> as shown:</p>\n<p><img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L07_IPSecCrack/.images/wiresharkcapture.png\" /></p>\n<p><em>Server found! </em>The initiator starts the SA request so the server will be 172.18.0.6. You can also see another exchange in Main Mode but this kind of exchange it's not vulnerable.</p>\n<h2>Step 2: Attack the Server</h2>\n<p>Now we can open a <strong>Kali shell</strong> and start the attack:</p>\n<p><img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L07_IPSecCrack/.images/attackershell.png\" /></p>\n<p>We use <em>ike-scan</em> and the related <em>psk-crack</em> tool to find the password. In the Kali container there is a dictionary that can be used to retrieve the password from the IKE packet captured with the handshake.</p>\n<p>We use <em>ike-scan</em> to retrieve the packet containing the non-encrypted hash; we can do that because aggressive mode does not require authentication:</p>\n<p><img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L07_IPSecCrack/.images/ikescan.png\" width=\"1205\" height=\"180\" /></p>\n<p>We can derive the password if we're lucky enough (don't worry...in the lab this will take less than a second!):</p>\n<p><img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L07_IPSecCrack/.images/pskcrack.png\" width=\"1203\" height=\"155\" /><em>Congrats!</em> Now you have all the data to instaurate a legitimate connection with the server ;-)</p>","readme":"","difficulty":"Medium","author":"NS"}
