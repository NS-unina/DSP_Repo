{"description":"/etc/passwd file permission rights misconfiguration and subsequent privilege escalation","goal":"<p>Explore various methods to escalate privileges on a linux machine exploiting misconfigurations of permissions on the /etc/passwd file</p>\n<p>This Lab was modeled after the following article: <a href=\"https://www.hackingarticles.in/editing-etc-passwd-file-for-privilege-escalation/\">https://www.hackingarticles.in/editing-etc-passwd-file-for-privilege-escalation/</a></p>","solution":"<p>First off, if you do not already have it, go ahead and grab our lightweight ssh client hack tool. <br />In a terminal on your host, type:</p>\n<p style=\"padding-left: 30px;\">$ docker pull nsunina/alpine_ssh:latest</p>\n<p>&nbsp;</p>\n<p>Start the lab and follow the standard procedure to attach an interactive hack tool. This will allow you to interact with the vulnerable environment.</p>\n<p>Create a new interactive service in the Hack Tool tab: name it \"ssh_client\", select \"nsunina/alpine_ssh:latest\" as base docker image and run it.</p>\n<p>&nbsp;<img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L_EXTRA_PrivilegeEscalation_PATH/.images/1.png\" alt=\"\" width=\"1367\" height=\"626\" /></p>\n<p>As soon as the container is up and running, attach it to the target network:</p>\n<p>&nbsp;<img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L_EXTRA_PrivilegeEscalation_PATH/.images/2.png\" alt=\"\" width=\"425\" height=\"123\" /></p>\n<p>Then, access the web shell.</p>\n<p><img src=\"https://raw.githubusercontent.com/NS-unina/DSP_Repo/master/L_EXTRA_PrivilegeEscalation_PATH/.images/3.png\" alt=\"\" width=\"277\" height=\"112\" /></p>\n<p>Connect to the vulnerable container via SSH as an unprivileged user. In reality, you will have to compromise the target machine and get remote access, before applying any of the following techniques.</p>\n<p style=\"padding-left: 30px;\">$ ssh <a href=\"mailto:user1@193.20.1.2\">user1@193.20.1.2</a></p>\n<p>The password is \"pass123\".</p>\n<h3>/etc/passwd file</h3>\n<p><span style=\"color: #000000;\">First of all, let's have a look at the relevant files that can be found inside the /etc directory:</span></p>\n<p><span style=\"color: #000000;\"><strong>etc/passwd: </strong>a text file which stores information about user accounts.</span></p>\n<p>&nbsp;</p>\n<p><span style=\"color: #000000;\"><strong>etc/group:</strong> users and the groups they belong to can be identified through this file .</span></p>\n<p>&nbsp;</p>\n<p><span style=\"color: #000000;\"><strong>etc/shadow: </strong>holds encrypted passwords and account expiration dates for every user.</span></p>\n<p>&nbsp;</p>\n<p><span style=\"color: #000000;\">If we take a look at the target machine's passwd file, we can understand its structure in detail.<br /></span></p>\n<p><span style=\"color: #000000;\"><img src=\"https://i.imgur.com/sFL3bDQ.png\" alt=\"\" width=\"841\" height=\"449\" /></span></p>\n<p><span style=\"color: #000000;\">As you can see, we get a bunch of user information for each row, separated by a colon character.</span></p>\n<p><span style=\"color: #000000;\">For instance, the last line has information about our current user.</span></p>\n<p>In order, we get:</p>\n<p><span style=\"color: #000000;\"><strong>Username</strong><br /></span></p>\n<p>&nbsp;</p>\n<p><span style=\"color: #000000;\"><strong>Encrypted password: </strong>The&nbsp;\"x\" indicates the encrypted password which is actually stored inside the /etc/shadow file. If the user does not have a password, then the password field will be an&nbsp;<span style=\"color: #993300;\"><strong>* </strong></span>(<strong>asterisk</strong>).</span></p>\n<p>&nbsp;</p>\n<p><span style=\"color: #000000;\"><strong>User Id (UID): </strong>Every user must be allotted a user ID (UID). UID <strong>0&nbsp;</strong>(zero) is for root user and UIDs <strong>1-99</strong> are assigned to predefined accounts, UID&nbsp;<strong>100-999</strong> are used by Linux for administrative purposes. UID <strong>1000</strong> is almost&nbsp;always the first non-system user.<br /></span></p>\n<p>&nbsp;</p>\n<p><span style=\"color: #000000;\"><strong>Group Id (GID):</strong> It denotes the group of each user; like as UIDs, the first&nbsp;<strong>100&nbsp;</strong>GIDs are usually reserved to the system. The <strong>0</strong> GID belongs to the&nbsp;root group&nbsp;and the <strong>1000</strong> GID usually belongs to the&nbsp;users. New groups GIDs usually begin from<strong>&nbsp;1000.</strong></span></p>\n<p>&nbsp;</p>\n<p><span style=\"color: #000000;\"><strong style=\"color: #000000;\">Gecos </strong><span style=\"color: #000000;\"><strong>Field</strong></span><strong style=\"color: #000000;\">: </strong><span style=\"color: #000000;\">a set of comma-separated values that tells more details about the users. The format for the GECOS field enlists the following information:</span></span></p>\n<p>&nbsp;</p>\n<p><span style=\"color: #000000;\">User&rsquo;s&nbsp;full name</span></p>\n<p>&nbsp;</p>\n<p><span style=\"color: #000000;\">Building and room number or contact person</span></p>\n<p>&nbsp;</p>\n<p><span style=\"color: #000000;\">Office&nbsp;telephone number</span></p>\n<p>&nbsp;</p>\n<p><span style=\"color: #000000;\">Home telephone number</span></p>\n<p>&nbsp;</p>\n<p><span style=\"color: #000000;\">Any other contact information</span></p>\n<p>&nbsp;</p>\n<p><span style=\"color: #000000;\"><strong>Home Directory: </strong>Denotes the path of the user&rsquo;s home directory, where all his files and programs are stored. If there is no specified directory then <span style=\"color: #993300;\"><strong>/</strong></span> becomes user&rsquo;s directory.</span></p>\n<p>&nbsp;</p>\n<p><span style=\"color: #000000;\"><strong>Shell:</strong> It denotes the full path of the default&nbsp;shell that executes user' commands and displays the results.</span></p>\n<h3><span style=\"color: #000000;\">Privilege Escalation</span></h3>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\">Generally, a normal user has read-only permission for passwd file. In many permissions misconfigurations, however,&nbsp; the /etc/passwd is also editable by users. Let's check it out with the usual command:<br /></span></span></p>\n<p style=\"padding-left: 30px;\"><span style=\"color: #000000;\"><span style=\"color: #000000;\">$ ls -la /etc/passwd</span></span></p>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\"><img src=\"https://i.imgur.com/QEjl205.png\" alt=\"\" width=\"476\" height=\"37\" /></span></span></p>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\">As you can see, all users have write permissions. </span></span></p>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\">Now, with the help of the aforementioned theory, we can add a new user and escalate the privileges.</span></span></p>\n<h4><span style=\"color: #000000;\"><span style=\"color: #000000;\">Manual editing</span></span></h4>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\">Let's first add a new root user manually. In order to do that, we can use openssl to create an encrypted password:<br /></span></span></p>\n<p style=\"padding-left: 30px;\"><span style=\"color: #000000;\"><span style=\"color: #000000;\">$ </span></span><span style=\"color: #000000;\"><span style=\"color: #000000;\"><span class=\"crayon-e\">openssl </span><span class=\"crayon-v\">passwd</span> <span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span> <span class=\"crayon-o\">-</span><span class=\"crayon-e\">salt </span><span class=\"crayon-e\">user2 </span><span class=\"crayon-v\">pass123</span></span></span></p>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\"><span class=\"crayon-v\">We do this because usually we are not allowed (as non-privileged users) to use the passwd command in order to set up the new user's password.</span></span></span></p>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\"><span class=\"crayon-e\"><img src=\"https://i.imgur.com/PFnnGJE.png\" alt=\"\" width=\"539\" height=\"36\" /></span></span></span></p>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\">Now we can use this password and edit the /etc/passwd file using vim.</span></span></p>\n<p style=\"padding-left: 30px;\"><span style=\"color: #000000;\"><span style=\"color: #000000;\">$ vim /etc/passwd</span></span></p>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\"><img src=\"https://i.imgur.com/nVFYCdJ.png\" alt=\"\" width=\"846\" height=\"451\" /></span></span></p>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\">Now we can attempt our root login, using the password \"pass123\"</span></span></p>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\"><img src=\"https://i.imgur.com/xgCG6W9.png\" alt=\"\" width=\"331\" height=\"59\" /></span></span></p>\n<p><span style=\"color: #000000;\"><span style=\"color: #000000;\">There are several utilities that allow us to create an encrypted password. It is useful to know the commands, in order to be ready to any target environment.</span></span></p>\n<h3><span style=\"color: #000000;\"><span style=\"color: #000000;\">mkpasswd</span></span></h3>\n<p style=\"padding-left: 30px;\"><span style=\"color: #000000;\"><span style=\"color: #000000;\">$ </span></span><span class=\"crayon-v\">mkpasswd</span> <span class=\"crayon-o\">-</span><span class=\"crayon-i\">m</span> <span class=\"crayon-v\">SHA</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">512</span> <span class=\"crayon-v\">pass123</span></p>\n<h3><span class=\"crayon-v\">Python</span></h3>\n<p style=\"padding-left: 30px;\"><span class=\"crayon-v\">$ </span><span class=\"crayon-v\">python</span> <span class=\"crayon-o\">-</span><span class=\"crayon-i\">c</span> <span class=\"crayon-s\">'import crypt; print crypt.crypt(\"pass123\", \"$6$salt\")'</span></p>\n<p style=\"padding-left: 30px;\">&nbsp;</p>\n<h3><span class=\"crayon-v\">Perl</span></h3>\n<p style=\"padding-left: 30px;\"><span class=\"crayon-v\">$ </span><span class=\"crayon-v\">perl</span> <span class=\"crayon-o\">-</span><span class=\"crayon-i\">le</span> <span class=\"crayon-s\">'print crypt(\"pass123\", \"abc\")'</span></p>\n<p style=\"padding-left: 30px;\">&nbsp;</p>\n<h3><span class=\"crayon-v\">PHP</span></h3>\n<p style=\"padding-left: 30px;\"><span class=\"crayon-v\">$ </span><span class=\"crayon-v\">php</span> <span class=\"crayon-o\">-</span><span class=\"crayon-i\">r</span> <span class=\"crayon-s\">\"print(crypt('efrcatu','pass123') . \\\"\\n\\\");\"</span></p>\n<p style=\"padding-left: 30px;\">&nbsp;</p>\n<p style=\"padding-left: 30px;\">&nbsp;</p>\n<p>&nbsp;</p>\n<p>&nbsp;</p>\n<p>&nbsp;</p>","readme":"","difficulty":"Beginner","author":"NS"}
